name: "Deploy with Reusable Workflows"

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '12.x'

jobs:
  
  build-and-test:
    name: ðŸ§ª Build and Test Code
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node: ['10.x', '12.x', '14.x']
    
    steps:
    - uses: actions/checkout@v2
    - name: Use Node.js ${{ matrix.node }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ matrix.node }}
    - name: npm install, build, and test
      run: |
        # Build and test the project
        npm install
        npm run build --if-present
        npm run test --if-present

  prettier:
    name: ðŸ§¹ Pretty Up Code
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        # Make sure the actual branch is checked out when running on pull requests
        ref: ${{ github.head_ref }}
    - name: Prettify code
      uses: creyD/prettier_action@v3.1
      with:
        # This part is also where you can pass other options, for example:
        prettier_options: --write **/*.{js,md}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  linter:
    name: ðŸ§¹ Lint Code
    # Set the agent to run on
    runs-on: ubuntu-latest
    needs: [build-and-test, prettier]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
        with:
          # Full git history is needed to get a proper list of changed files within `super-linter`
          fetch-depth: 0

  code-scan:
      name: Scan Code
      runs-on: ubuntu-latest
      needs: [build-and-test, prettier]
      permissions:
        actions: read
        contents: read
        security-events: write

      steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: javascript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

  dependency-scan:
    name: Scan Dependencies
    runs-on: ubuntu-latest
    needs: [build-and-test, prettier]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: Dependency Review
        uses: actions/dependency-review-action@v1

  call-deploy-sandbox:
    name: ðŸ“¦ Call Deploy - Sandbox
    uses: rocket-labs-inc/centralized-actions/.github/workflows/webapp-deploy.yml@main
    with:
      environment: sandbox
    secrets: inherit
    needs: [code-scan, dependency-scan]

  call-deploy-qa:
    name: ðŸ“¦ Call Deploy - QA
    uses: rocket-labs-inc/centralized-actions/.github/workflows/webapp-deploy.yml@main
    with:
      environment: qa
    secrets: inherit
    needs: call-deploy-sandbox
